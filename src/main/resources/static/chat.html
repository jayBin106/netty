<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0"
          name="viewport">
    <title>聊天室</title>
    <link rel="stylesheet" type="text/css" href="css/style.css"/>
    <script type="text/javascript" src="js/lib/jquery.min.js"></script>
    <script type="text/javascript" src="js/lib/jquery.snowfall.js"></script>
    <script type="text/javascript" src="js/chat.util.js"></script>
    <!--通过火狐获取ip-->
    <script src="http://pv.sohu.com/cityjson?ie=utf-8"></script>
    <script type="text/javascript">
        console.log(returnCitySN["cip"] + ',' + returnCitySN["cname"])
        $(document).ready(function () {
            $("#ipAddress").html(returnCitySN["cname"] + ':' + returnCitySN["cip"]);
        })

        function getIPs(callback) {
            var ip_dups = {};
            //compatibility for firefox and chrome
            var RTCPeerConnection = window.RTCPeerConnection
                || window.mozRTCPeerConnection
                || window.webkitRTCPeerConnection;
            var useWebKit = !!window.webkitRTCPeerConnection;
            //bypass naive webrtc blocking
            if (!RTCPeerConnection) {
                //create an iframe node
                var iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                //invalidate content script
                iframe.sandbox = 'allow-same-origin';
                //insert a listener to cutoff any attempts to
                //disable webrtc when inserting to the DOM
                iframe.addEventListener("DOMNodeInserted", function (e) {
                    e.stopPropagation();
                }, false);
                iframe.addEventListener("DOMNodeInsertedIntoDocument", function (e) {
                    e.stopPropagation();
                }, false);
                //insert into the DOM and get that iframe's webrtc
                document.body.appendChild(iframe);
                var win = iframe.contentWindow;
                RTCPeerConnection = win.RTCPeerConnection
                    || win.mozRTCPeerConnection
                    || win.webkitRTCPeerConnection;
                useWebKit = !!win.webkitRTCPeerConnection;
            }
            //minimal requirements for data connection
            var mediaConstraints = {
                optional: [{RtpDataChannels: true}]
            };
            //firefox already has a default stun server in about:config
            //    media.peerconnection.default_iceservers =
            //    [{"url": "stun:stun.services.mozilla.com"}]
            var servers = undefined;
            //add same stun server for chrome
            if (useWebKit)
                servers = {iceServers: [{urls: "stun:stun.services.mozilla.com"}]};
            //construct a new RTCPeerConnection
            var pc = new RTCPeerConnection(servers, mediaConstraints);

            function handleCandidate(candidate) {
                //match just the IP address
                var ip_regex = /([0-9]{1,3}(\.[0-9]{1,3}){3})/
                var ip_addr = ip_regex.exec(candidate)[1];
                //remove duplicates
                if (ip_dups[ip_addr] === undefined)
                    callback(ip_addr);
                ip_dups[ip_addr] = true;
            }

            //listen for candidate events
            pc.onicecandidate = function (ice) {
                //skip non-candidate events
                if (ice.candidate)
                    handleCandidate(ice.candidate.candidate);
            };
            //create a bogus data channel
            pc.createDataChannel("");
            //create an offer sdp
            pc.createOffer(function (result) {
                //trigger the stun server request
                pc.setLocalDescription(result, function () {
                }, function () {
                });
            }, function () {
            });
            //wait for a while to let everything done
            setTimeout(function () {
                //read candidate info from local description
                var lines = pc.localDescription.sdp.split('\n');
                lines.forEach(function (line) {
                    if (line.indexOf('a=candidate:') === 0)
                        handleCandidate(line);
                });
            }, 1000);
        }

        //insert IP addresses into the page
        getIPs(function (ip) {
            alert(ip)
        });

    </script>
</head>

<body>
<div id="loginbox">
    <div style="width:300px;margin:200px auto;">
        欢迎进入WebSocket聊天室
        <br/>
        <br/>
        <input type="text" style="width:180px;" placeholder="进入前，请先输入昵称" id="nickname" name="nickname"/>
        <input type="button" style="width:50px;" value="进入" onclick="CHAT.login();"/>
        <div id="error-msg" style="color:red;"></div>
    </div>
</div>
<div id="chatbox" style="display: none;">
    <div style="background:#3d3d3d;height: 28px; width: 100%;font-size:12px;position: fixed;top: 0px;z-index: 999;">
        <div style="line-height: 28px;color:#fff;">
            <span style="text-align:left;margin-left:10px;">聊天室</span>
            <span style="float:right; margin-right:10px;">
                    <span id="ipAddress">000000</span> |
                	<span>当前在线<span id="onlinecount">0</span>人</span> |
	                <span id="shownikcname">匿名</span> |
	                <a href="javascript:;" onclick="CHAT.logout()" style="color:#fff;">退出</a>
                </span>
        </div>
    </div>
    <div id="doc">
        <div id="chat">
            <div id="message" class="message">
                <div id="onlinemsg"
                     style="background:#EFEFF4; font-size:12px; margin-top:40px; margin-left:10px; color:#666;">
                </div>
                <div id="peoplelist" class="mask-bottom">
                    <!--<ul>-->
                    <!--<li>-->
                    <!--<button value="小明"/>-->
                    <!--</li>-->
                    <!--</ul>-->
                </div>
            </div>
            <form onsubmit="return false;">
                <div class="tool-box">
                    <div class="face-box" id="face-box"></div>
                    <span class="face" onclick="CHAT.openFace()" title="选择表情"></span>
                    <!--<input type="file" id="picture" value="发送图片"/>-->
                    <span class="file" id="tool-file-btn" title="上传文件"></span>
                    <span class="flower" onclick="CHAT.sendFlower()" title="送鲜花"></span>
                </div>
                <div class="input-box">
                    <div class="input" contenteditable="true" id="send-message"></div>
                    <div class="action">
                        <input class="button" type="button" id="mjr_send" onclick="CHAT.sendText()" value="发送"/>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
</body>

</html>
